---
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T)
```

# bgg_data

loading historical data from BGG for predictive modeling and analysis

1. loads universe of game ids from [bgg activity club](http://bgg.activityclub.org/bggdata/thingids.txt])
2. submits batches of requests via [bggUtils](https://github.com/phenrickson/bggUtils)
3. stores responses on BigQuery and Google Cloud Storage

## targets

uses [targets](https://github.com/ropensci/targets) package to create pipeline

## setup

```{r packages, include = F}

library(dplyr)
library(tibble)
library(qs)

googleCloudStorageR::gcs_auth(
        json_file = Sys.getenv("GCS_AUTH_FILE")
)

googleCloudStorageR::gcs_global_bucket("bgg_data")

```

## data

batches of game ids:

```{r, message = F, echo = F}

googleCloudStorageR::gcs_list_objects(versions = T) |>
        filter(name == 'raw/objects/game_ids') %>%
        arrange(desc(updated))

```

most recent batch of game ids submitted to API:

```{r most recent game ids, echo = F}

game_ids = targets::tar_read("game_ids")

batch_ts = attr(game_ids, "timestamp")

game_ids %>%
        add_column(batch_ts) %>%
        group_by(batch_ts, type) %>%
        summarize(
                n = n_distinct(id),
                .groups = 'drop'
        )
```
most recent batch of games data loaded to GCS:

```{r most recent games, message = F, echo = F}

games = targets::tar_read("games")

games %>% 
        group_by(batch_ts, type) %>% 
        summarize(n = n_distinct(game_id), .groups = 'drop')

```

new games in most recent batch:

```{r show new games, message = F, echo = F}

games_batch_detail = 
        googleCloudStorageR::gcs_list_objects(versions = T, detail = "full") |>
        filter(name == 'raw/objects/games') %>%
        select(name, bucket, generation, updated) |>
        arrange(updated)

active_gen = 
        games_batch_detail |>
        filter(updated == max(updated)) |>
        slice_max(updated, n = 1, with_ties = F) |>
        pull(generation)

prev_gen = 
        games_batch_detail |>
        filter(updated != max(updated)) |>
        slice_max(updated, n = 1, with_ties = F) |>
        pull(generation)

# load batches of games
active_batch = 
        googleCloudStorageR::gcs_get_object(
                'raw/objects/games',
                generation = active_gen
        ) |>
        qs::qdeserialize()

prev_batch = 
        googleCloudStorageR::gcs_get_object(
                'raw/objects/games',
                generation = prev_gen
        ) |>
        qs::qdeserialize()

# show new games
active_batch |>
        filter(!(game_id %in% (prev_batch$game_id))) |>
        mutate(name = purrr::map_chr(names,
                                     ~ .x |> 
                                             filter(type == 'primary') |>
                                             pull(value))
        ) |>
        select(game_id, info, name, batch_ts) |>
        tidyr::unnest(info) |>
        select(game_id, yearpublished, name, description, batch_ts) |>
        arrange(desc(yearpublished))

```